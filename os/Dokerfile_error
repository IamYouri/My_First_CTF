FROM ubuntu:20.04

# Installer SSH et autres dépendances
RUN apt-get update && apt-get install -y openssh-server sudo curl

# Installer Node.js et npm
RUN curl -fsSL https://deb.nodesource.com/setup_14.x | bash - && \
    apt-get install -y nodejs

# Créer un répertoire pour SSH
RUN mkdir /var/run/sshd

# Créer un utilisateur pour SSH
RUN useradd -ms /bin/bash user
RUN echo 'user:password' | chpasswd
RUN echo 'user ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

# Autoriser les connexions root via SSH (facultatif et non recommandé en production)
RUN echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config

# Exposer le port SSH
EXPOSE 22

# Définir le répertoire de travail
WORKDIR /usr/src/app

# Copier les fichiers package.json et package-lock.json
COPY package*.json ./

# Installer les dépendances
RUN npm install

# Copier le reste des fichiers de l'application
COPY . .

# Exposer le port de l'application
EXPOSE 5000

# Démarrer le service SSH et l'application Node.js
CMD ["/usr/sbin/sshd", "-D"]
CMD ["node", "serveur.js"]
